{"version":3,"sources":["../../scripts/main.ts","../../scripts/maintenance.ts"],"sourcesContent":["import { world, system, ChatSendAfterEvent, PlayerJoinAfterEvent, PlayerSpawnAfterEvent, EntityInventoryComponent, EntityDieAfterEvent, Player, EntityComponentTypes, Entity, Vector3, BlockVolume, BlockVolumeBase, BlockComponent, BlockComponentTypes, BlockType, BlockTypes, ItemStack, EntityEquippableComponent, EquipmentSlot } from \"@minecraft/server\";\nimport { BP_VERSION, version_documentation } from \"./maintenance\";\n\nconst VERSION_CHECK_SCOREBOARD = \"VERSION_CHECK_SCOREBOARD\"\nconst HOME_LOCATION_SCOREBOARD = \"HOME_LOCATION_SCOREBOARD\"\nconst SERVER_NAME = \"서버\"\nvar ticks = 1\n\ninterface StringVec3Dictionary {\n  [key: string]: Vector3;\n}\nconst groundedPositionMap : StringVec3Dictionary = {}\n\n\n// Entry Points\nmainLoop();\nworld.afterEvents.chatSend.subscribe(onPlayerChatSend)\nworld.afterEvents.playerSpawn.subscribe(onPlayerSpawn)\nworld.afterEvents.entityDie.subscribe(onEntityDie)\nlet initCounter = 0\n\n\n// Setup Function\nfunction mainLoop() {  \n  ticks = (ticks + 1) % 20\n  if (ticks == 0){\n    checkPlayersLastGroundedPosition()\n  }\n  system.run(mainLoop);\n  \n}\n\n// Player Spawn Hook\nfunction onPlayerSpawn(eventData: PlayerSpawnAfterEvent){\n  if (!eventData.initialSpawn) {return;}\n  eventData.player.sendMessage(`${eventData.player.name}, ${SERVER_NAME}에 접속한 것을 환영합니다!`)\n  eventData.player.sendMessage(`현재시간은 ${world.getDay()}일 ${Math.floor(world.getTimeOfDay()/ 1000)}시 ${Math.floor((world.getTimeOfDay() % 1000) / 1000 * 60)}분 입니다.`)\n  let joinedString = world.getAllPlayers().map(player => player.name).join(', ');\n  eventData.player.sendMessage(\"현재 접속자는 \" + joinedString +\"입니다.\");\n    \n  let vcScoreboard = world.scoreboard.getObjective(VERSION_CHECK_SCOREBOARD)\n  \n  // Initialize scoreboards if not present.\n  if (!vcScoreboard){\n    vcScoreboard = world.scoreboard.addObjective(VERSION_CHECK_SCOREBOARD, \"Player-Versions\")\n  }\n\n  // Add player if not present.\n  let is_newbie = false\n  let is_version_upgrade = false\n  if (!vcScoreboard.hasParticipant(eventData.player)){\n    is_newbie = true\n    is_version_upgrade = true\n  } else {\n    var s = vcScoreboard.getScore(eventData.player) \n    if (s != undefined && s != BP_VERSION){\n      is_version_upgrade = true\n    }\n  }\n  vcScoreboard.setScore(eventData.player, BP_VERSION)\n  if (is_version_upgrade){\n    eventData.player.sendMessage(`====================================`)\n    eventData.player.sendMessage(`서버가 업데이트되었습니다. (-> ${BP_VERSION})`)\n    if(BP_VERSION in version_documentation){\n      eventData.player.sendMessage(`추가 내용:`)\n      for (let message of version_documentation[BP_VERSION]){\n        eventData.player.sendMessage(\"    \" + message as string)\n      }\n    }\n  }\n  eventData.player.sendMessage(`====================================`)\n}\n\nfunction onPlayerChatSend(eventData: ChatSendAfterEvent){\n  \n  let player = eventData.sender\n  let messageComponents = eventData.message.split(\" \")\n\n  if (messageComponents.length == 0) return\n  switch (messageComponents[0]){\n  \n    case \"!tp\": {\n      if (messageComponents.length != 2){\n        player.sendMessage(`tp > 사용법 '!tp <playername>'`)\n        player.sendMessage(\"접속중인 사용자:\")\n        world.getAllPlayers().forEach(target => {\n          player.sendMessage(\"    \" + target.name);\n        });\n        return\n      }\n      for (let target of world.getAllPlayers()) {\n        if (target.name == messageComponents[1]){\n          let tpSuccess = player.tryTeleport(target.location, {dimension: target.dimension})\n          if (tpSuccess){\n            player.sendMessage(`tp > ${target.name}에게 소환되었습니다.`)\n            player.resetLevel()\n          } else {\n            player.sendMessage(`tp > ${target.name}는 현재 소환할 수 있는 위치가 아닙니다.`)\n          }\n          return\n        }\n      }\n      player.sendMessage(`tp > 이름 ${messageComponents[1]}은 유효하지 않습니다.`)\n      player.sendMessage(\"접속중인 사용자:\")\n      world.getAllPlayers().forEach(target => {\n        player.sendMessage(\"    \" + target.name);\n      });\n      return\n    }\n\n    case \"!sethome\": {\n      if (player.dimension.id != \"minecraft:overworld\") {\n        player.sendMessage(`sethome > 홈 설정은 오버월드에서만 가능합니다.`)\n        return\n      }\n      let hlScoreboard = world.scoreboard.getObjective(HOME_LOCATION_SCOREBOARD)\n  \n      // Initialize scoreboards if not present.\n      if (!hlScoreboard){\n        hlScoreboard = world.scoreboard.addObjective(HOME_LOCATION_SCOREBOARD, \"Home-Location\")\n      }\n\n      hlScoreboard.setScore(\"x\", player.location.x)\n      hlScoreboard.setScore(\"y\", player.location.y)\n      hlScoreboard.setScore(\"z\", player.location.z)\n      \n      player.sendMessage(`sethome > 성공!`)\n      return\n      \n    }\n\n    case \"!home\": {\n      let hlScoreboard = world.scoreboard.getObjective(HOME_LOCATION_SCOREBOARD)\n  \n      if (!hlScoreboard){\n        player.sendMessage(`home > 집 위치가 설정되지 않았습니다.`)\n        return\n      }\n      let px = hlScoreboard.getScore(\"x\")\n      let py = hlScoreboard.getScore(\"y\")\n      let pz = hlScoreboard.getScore(\"z\")\n      if( px != undefined && py != undefined && pz != undefined){\n        let tpSuccess = player.tryTeleport({x: px, y: py, z: pz}, {dimension: world.getDimension(\"minecraft:overworld\")})\n          if (tpSuccess){\n            \n            player.resetLevel()\n            player.sendMessage(`home > 집으로 소환되었습니다.`)\n          } else {\n            player.sendMessage(`home > 집은 현재 소환할 수 있는 위치가 아닙니다.`)\n          }\n          return\n      }\n\n      player.sendMessage(`home > 오류`)\n      return\n    }\n  }\n}\n\n\nfunction onEntityDie(eventData: EntityDieAfterEvent){\n  let e = eventData.deadEntity\n  if (e instanceof Player){\n    let inventory = e.getComponent(EntityComponentTypes.Inventory) as EntityInventoryComponent\n    let equipment = e.getComponent(EntityComponentTypes.Equippable) as EntityEquippableComponent\n    let pos = undefined\n    if (inventory && equipment){\n      // Find suitable void location in vertical area\n\n      if (!(e.id in groundedPositionMap)){\n        e.sendMessage(\"서버 > 에러로 인해 아이템이 유지되었습니다. 관리자에게 문의해 주세요\")\n        return\n      }\n      pos = {x: groundedPositionMap[e.id].x, y: groundedPositionMap[e.id].y, z: groundedPositionMap[e.id].z}  as Vector3\n      console.log(pos.x, pos.y, pos.z)\n      e.dimension.setBlockType(pos, \"minecraft:chest\")\n\n      if (pos){\n        console.log(1)\n        let chest = e.dimension.getBlock(pos)\n        let chestContainer = chest?.getComponent(BlockComponentTypes.Inventory)?.container\n        \n        // Success! Actual logic from now on\n        let size = inventory.container?.size\n\n        \n        if (chestContainer && size){\n          \n          console.log(2)\n          for (let slot of [EquipmentSlot.Chest, EquipmentSlot.Feet, EquipmentSlot.Head, EquipmentSlot.Legs, EquipmentSlot.Mainhand, EquipmentSlot.Offhand]){\n            let eq = equipment.getEquipment(slot)\n            if (eq){\n              let success = chestContainer.addItem(eq)\n              if (success instanceof ItemStack){\n                e.dimension.spawnItem(success, {x: pos.x, y: pos.y + 1, z: pos.z})\n              }\n            }\n            equipment.setEquipment(slot, undefined)\n          }\n\n          for(let i = 0; i < size; i++){\n            let success = inventory.container?.transferItem(i, chestContainer)\n            if (success instanceof ItemStack){\n              e.dimension.spawnItem(success, {x: pos.x, y: pos.y + 1, z: pos.z})\n            }\n          }\n\n\n          inventory.container?.clearAll()\n          let is = new ItemStack(\"minecraft:paper\", 1)\n          is.nameTag =`사망 위치: ${Math.floor(pos.x)}, ${Math.floor(pos.y)}, ${Math.floor(pos.z)}`\n          inventory.container?.addItem(is)\n        }\n      }\n    }\n  }\n}\n\nfunction _findVoidBlockInRadius(e: Entity, i: number): Vector3 | undefined{\n  let blocks = e.dimension.getBlocks(new BlockVolume({x: e.location.x - i, y: e.location.y - i, z: e.location.z - i}, {x: e.location.x + i, y: e.location.y + i, z: e.location.z + i}), \n                  {includeTypes: [\"minecraft:air\"]}, true)\n  let blockpos: Vector3 | undefined = undefined\n  for (let i of blocks.getBlockLocationIterator()){\n    blockpos = i\n    break\n  }\n  return blockpos\n  \n}\nfunction checkPlayersLastGroundedPosition(){\n  for(let i of world.getAllPlayers()){\n    if (i.isOnGround && !i.dimension.getBlock(i.getHeadLocation())?.isLiquid){\n      \n      try{\n      \n      groundedPositionMap[i.id] = {x: i.location.x, y: i.location.y, z: i.location.z};\n      } catch (e){\n\n        console.log(e)\n      }\n    }\n  }\n\n}","// Globals\r\nexport const BP_VERSION = 3;\r\n\r\nexport const version_documentation = {\r\n  0 : [\"!tp <사용자 이름> -> 사용자에게 순간이동함.\"],\r\n  1 : [\"!home -> 집으로 tp\"],\r\n  2 : [\"이제 사망시 아이템이 죽은 위치의 상자로 이동됩니다. 단 아이템이 너무 많은 경우 그대로 떨어질 수 있습니다.\"],\r\n  3 : [\"용암에서 사망시 상자가 용암 아래에 생성되는 버그 수정\"]\r\n}"],"mappings":"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","names":[],"file":"../scripts/main.js"}